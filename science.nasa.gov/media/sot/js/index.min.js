/*global document, window, setInterval, Cesium, Image, navigator, twoline2rv, sgp4, tle, gstime*/(function(){"use strict";function E(){S();i.getImageryLayers().addImageryProvider(w.bing);n.getPrimitives().setCentralBody(i);n.skyAtmosphere=new Cesium.SkyAtmosphere;n.skyBox=new Cesium.SkyBox({positiveX:h+"/tycho2t3_80_px.jpg",negativeX:h+"/tycho2t3_80_mx.jpg",positiveY:h+"/tycho2t3_80_py.jpg",negativeY:h+"/tycho2t3_80_my.jpg",positiveZ:h+"/tycho2t3_80_pz.jpg",negativeZ:h+"/tycho2t3_80_mz.jpg"});n.getPrimitives().add(s);b==="null"&&L(n);document.getElementById("select_satellite_group").value=y;x(document.getElementById("select_satellite_group").value);C();k();M(n);B(n)}function S(){function e(e){var t={},n=window.location.search.substring(1),r=n.split("&");for(var i=0;i<r.length;i++){var s=r[i].split("=");if(typeof t[s[0]]=="undefined")t[s[0]]=s[1];else if(typeof t[s[0]]=="string"){var o=[t[s[0]],s[1]];t[s[0]]=o}else t[s[0]].push(s[1])}return t}var t=window.location.search.substring(1),n=e(t);n.group!==undefined&&(y=n.group);n.satellite!==undefined&&(b=n.satellite)}function x(e){var t,n,r,i,s,u,f;e="media/sot/tle/"+e+".txt";var l=tle.parseFile(e);o=[];a=[];for(t=0,n=l.length;t<n;t+=1){a[t]={name:l[t][0].trim(),intlDesig:l[t][1].slice(9,17),noradId:l[t][2].split(" ")[1],tle0:l[t][0],tle1:l[t][1],tle2:l[t][2]};r=twoline2rv(d,l[t][1],l[t][2],v,m);i=r.shift();s=r.shift();u=r.shift();f=r.shift();o.push(i)}}function T(e,t){var n=[],r=[],i=[],s,o,a,f,l,c,h,p,d;for(s=0,o=e.length;s<o;s+=1){a=e[s];f=new Cesium.JulianDate.fromTotalDays(a.jdsatepoch);l=f.getMinutesDifference(t);c=sgp4(e[s],l);h=c.shift();p=c.shift();d=c.shift();n.push(h);r.push(p);i.push(d)}u=r;return{satrecs:n,positions:r,velocities:i}}function N(e){var t=new Cesium.JulianDate,n,i,s,o,u;r.modelMatrix=Cesium.Matrix4.fromRotationTranslation(Cesium.Transforms.computeTemeToPseudoFixedMatrix(t),Cesium.Cartesian3.ZERO);for(n=0,i=e.length;n<i;n+=1){u=r.get(n);s=e[n];o=new Cesium.Cartesian3(s[0]*1e3,s[1]*1e3,s[2]*1e3);u.setPosition(o)}}function C(){var e=document.getElementById("select_satellite"),t={},n,r,i,s;for(n=0,r=o.length;n<r;n+=1)t[a[n].name]=n;s=Object.keys(t);s.sort();e.innerHTML="";i=document.createElement("option");e.appendChild(i);for(n=0,r=s.length;n<r;n+=1){i=document.createElement("option");i.textContent=s[n];i.value=t[s[n]];e.appendChild(i)}}function k(){var e,t,i,s=new Image;r.removeAll();for(e=0,t=a.length;e<t;e+=1){i=r.add({imageIndex:0,position:new Cesium.Cartesian3(0,0,0)});i.satelliteName=a[e].name;i.satelliteNoradId=a[e].noradId;i.satelliteDesignator=a[e].intlDesig;i.satelliteData=a[e];i.satelliteNum=e}n.getPrimitives().add(r);s.src="media/sot/images/Satellite.png";s.onload=function(){var e=n.getContext().createTextureAtlas({image:s});r.setTextureAtlas(e)}}function L(e){function n(n){var r=t.cartographicToCartesian(Cesium.Cartographic.fromDegrees(n.coords.longitude,n.coords.latitude)),i=t.cartographicToCartesian(Cesium.Cartographic.fromDegrees(n.coords.longitude,n.coords.latitude,1e7)),s=new Cesium.Cartesian3(0,0,1),o=new Image;o.src="media/sot/images/icon_geolocation.png";o.onload=function(){var t=new Cesium.BillboardCollection,n=e.getContext().createTextureAtlas({image:o});t.setTextureAtlas(n);t.modelMatrix=Cesium.Transforms.eastNorthUpToFixedFrame(r);t.add({imageIndex:0,position:new Cesium.Cartesian3(0,0,0)});e.getPrimitives().add(t)};e.getCamera().controller.lookAt(i,r,s)}"geolocation"in navigator&&navigator.geolocation.getCurrentPosition(n)}function A(e){e=e.trim().toLowerCase();e=e.split("(")[0].trim();e=e.replace("/","-");e=e.replace(/[^\w\s\-]/,"");e=e.replace(/[\-\s]+/,"-");return e}function O(){function t(){var e=document.createElement("textarea");e.cols=1;e.rows=1;e.style.visibility="hidden";e.style.border="none";document.body.appendChild(e);var t=e.offsetWidth-e.clientWidth;document.body.removeChild(e);return t}var r=document.getElementById("iSat_header").offsetHeight,i=document.getElementById("iSat_header").offsetWidth-t(),s=window.innerHeight-r;if(e.width===i&&e.height===s)return;e.width=i;e.height=s;var o=document.getElementById("cesiumContainer");o.width=i;o.height=s;n.getCamera().frustum.aspectRatio=i/s}function M(t){var n=new Cesium.ScreenSpaceEventHandler(t.getCanvas());n.setInputAction(function(n){var r=t.pick(n.endPosition),i=document.getElementById("satellite_popup"),s=e.offsetTop;if(r&&r.satelliteName){i.textContent=r.satelliteName;i.style.left=n.endPosition.x+"px";i.style.top=n.endPosition.y+s-50+"px";i.style.display="";i.style.position="absolute";i.className="modal"}else i.style.display="none"},Cesium.ScreenSpaceEventType.MOUSE_MOVE)}function _(e){var t=0,n=0,r=2*Math.PI;n=e;t=parseInt(n/r);n-=t*r;n<0&&(n+=r);return n}function D(e,t,n){var r=0,i=0,s=0,o=0,u=.00335281066474748,a=6.283185307179586,f=1.5707963267948966,l=3.141592653589793,c=6378.137,h=57.295;n.theta=Math.atan2(t[1],t[0]);n.lonInRads=_(n.theta-gstime(e));r=Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2));i=u*(2-u);n.latInRads=Math.atan2(t[2],r);do{s=n.latInRads;o=1/Math.sqrt(1-i*Math.pow(Math.sin(s),2));n.latInRads=Math.atan2(t[2]+c*o*i*Math.sin(s),r)}while(Math.abs(n.latInRads-s)>=1e-10);n.alt=r/Math.cos(n.latInRads)-c*o;n.latInRads>f&&(n.latInRads-=a);n.lonInRads>l&&(n.lonInRads=-a+n.lonInRads);n.latInDegrees=n.latInRads*h;n.lonInDegrees=n.lonInRads*h}function P(){var e=f,t,n,r,i,s,l=new Cesium.JulianDate;if(o.length>0){s=T(o,l);o=s.satrecs}document.getElementById("satellite_display").setAttribute("style","display:block");t=s.positions[e];n=s.velocities[e];r=new Cesium.Cartesian3(n[0],n[1],n[2]);var c=l.getJulianDayNumber()+l.getJulianTimeFraction();i=D(c,u[e],o[e]);document.getElementById("satellite_name").innerHTML=a[e].name;document.getElementById("satellite_id").innerHTML=a[e].noradId;b=a[e].noradId;var h=r.magnitude(),p=h*.621371;document.getElementById("satellite_velocity_kms").innerHTML=h.toFixed(3);document.getElementById("satellite_velocity_ms").innerHTML=p.toFixed(3);document.getElementById("satellite_latInDegrees").innerHTML=o[e].latInDegrees.toFixed(3);document.getElementById("satellite_lonInDegrees").innerHTML=o[e].lonInDegrees.toFixed(3);var d=o[e].alt,v=d*.621371;document.getElementById("satellite_height_km").innerHTML=d.toFixed(3);document.getElementById("satellite_height_m").innerHTML=v.toFixed(3);y!=="SMD"&&document.getElementById("smd_info").setAttribute("style","display:none")}function H(){b=="null"?window.history.replaceState(null,null,"?group="+y):window.history.replaceState(null,null,"?group="+y+"&satellite="+b)}function B(e){var t=new Cesium.ScreenSpaceEventHandler(e.getCanvas());t.setInputAction(function(t){var n=e.pick(t.position),r="http://science.nasa.gov/missions/",i="http://nssdc.gsfc.nasa.gov/nmc/spacecraftDisplay.do?id=",s,o,u;if(n){s=n.satelliteName.toLowerCase();o=n.satelliteDesignator;if(typeof window!="undefined"){r+=A(s)+"/";document.getElementById("science_url").href=r;console.log("hi");Number(o.slice(0,2))<20?u="20":u="19";i+=u+o.slice(0,2)+"-"+o.slice(2);document.getElementById("nssdc_url").href=i;f=n.satelliteNum}j();F();P();H()}},Cesium.ScreenSpaceEventType.LEFT_CLICK)}function j(){var e=f,t=Cesium.Cartesian3.ZERO,i=new Cesium.Cartesian3(0,0,1),s,o,u,a,l;for(o=0,u=r.getLength();o<u;o+=1){s=r.get(o);if(s.hasOwnProperty("isSelected")){delete s.isSelected;s.setColor({red:1,blue:1,green:1,alpha:1});s.setScale(1)}if(o===e){s=r.get(e);s.isSelected=!0;s.setColor({red:1,blue:0,green:1,alpha:1});s.setScale(2);a=s.getPosition()}}if(n.mode===Cesium.SceneMode.SCENE3D){n.getCamera().transform=Cesium.Matrix4.fromRotationTranslation(Cesium.Transforms.computeTemeToPseudoFixedMatrix(new Cesium.JulianDate),Cesium.Cartesian3.ZERO);l=new Cesium.Cartesian3.clone(a);l=l.multiplyByScalar(2);n.getCamera().controller.lookAt(l,t,i)}}function F(){var e=f,t=[],n=[],r=o[e],i=new Cesium.JulianDate.fromTotalDays(r.jdsatepoch),u=new Cesium.JulianDate,a=2*Math.PI/r.no,l=144,c=a/l,h,p,d,v,m,g;s.modelMatrix=Cesium.Matrix4.fromRotationTranslation(Cesium.Transforms.computeTemeToPseudoFixedMatrix(u),Cesium.Cartesian3.ZERO);for(h=0;h<=a;h+=c){p=u.addMinutes(h);d=i.getMinutesDifference(p);v=sgp4(r,d);r=v.shift();m=v.shift();g=new Cesium.Cartesian3(m[0],m[1],m[2]);g=g.multiplyByScalar(1e3);t.push(g);n.push(m)}s.removeAll();var y=new Cesium.Material({fabric:{type:"Color",uniforms:{color:{red:1,green:0,blue:.8,alpha:.7}}}}),b=s.add();b.setPositions(t);b.setMaterial(y);b.setWidth(2)}function I(e){var t=w[e];if(t){i.getImageryLayers().removeAll();i.getImageryLayers().addImageryProvider(t)}}var e=document.getElementById("glCanvas"),t=Cesium.Ellipsoid.WGS84,n=new Cesium.Scene(e),r=new Cesium.BillboardCollection,i=new Cesium.CentralBody(t),s=new Cesium.PolylineCollection,o=[],u=[],a=[],f=null,l=new Cesium.SceneTransitioner(n,t),c="media/sot/cesium/Assets/Textures",h=c+"/SkyBox",p=1e3,d=72,v="m",m="n",g=!0,y="SMD",b="null",w={bing:new Cesium.BingMapsImageryProvider({url:"http://dev.virtualearth.net",mapStyle:Cesium.BingMapsStyle.AERIAL_WITH_LABELS}),osm:new Cesium.OpenStreetMapImageryProvider({url:"http://otile1.mqcdn.com/tiles/1.0.0/osm"}),"static":new Cesium.SingleTileImageryProvider({url:c+"/NE2_LR_LC_SR_W_DR_2048.jpg"}),arcgis:new Cesium.ArcGisMapServerImageryProvider({url:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",proxy:new Cesium.DefaultProxy("http://cesium.agi.com/proxy/")})};E();window.addEventListener("resize",O,!1);O();document.getElementById("select_satellite").onchange=function(){var e="http://science.nasa.gov/missions/",t="http://nssdc.gsfc.nasa.gov/nmc/spacecraftDisplay.do?id=",n,r,i;document.getElementById("satellite_form").setAttribute("style","display:none");f=Number(this.value);n=a[f].name.toLowerCase();r=a[f].intlDesig;e+=A(n)+"/";document.getElementById("science_url").href=e;Number(r.slice(0,2))<20?i="20":i="19";t+=i+r.slice(0,2)+"-"+r.slice(2);document.getElementById("nssdc_url").href=t;P();j();F();H()};document.getElementById("bing_data_button").onclick=function(){I("bing")};document.getElementById("osm_data_button").onclick=function(){I("osm")};document.getElementById("arcgis_data_button").onclick=function(){I("arcgis")};document.getElementById("static_data_button").onclick=function(){I("static")};document.getElementById("three_d_display_button").onclick=function(){l.to3D()};document.getElementById("columbus_display_button").onclick=function(){l.toColumbusView()};document.getElementById("two_d_display_button").onclick=function(){l.to2D()};document.getElementById("select_satellite_group").onchange=function(){s.removeAll();x("media/sot/tle/"+this.value+".txt");y=this.value;b="null";f=null;document.getElementById("satellite_display").setAttribute("style","display:none");window.history.replaceState(null,null,"?group="+y);x(this.value);C();k();L(n)};if(b!=="null"){for(var q=0;q<o.length;q++)if(o[q]["satnum"]==b){f=q;var R=new Cesium.JulianDate,U=T(o,R);N(U.positions);j();F()}document.getElementById("select_satellite").value=f}b=="null"&&window.history.replaceState(null,null,"?group="+y);document.getElementById("reset_button").onclick=function(){window.location.reload()};document.getElementById("instructions_button").onclick=function(){if(document.getElementById("instructions").style.display==="none"||!document.getElementById("instructions").style.display){document.getElementById("instructions").setAttribute("style","display:block");document.getElementById("satellite_form").setAttribute("style","display:none");document.getElementById("map_display").setAttribute("style","display:none")}else document.getElementById("instructions").setAttribute("style","display:none")};document.getElementById("instructions_close").onclick=function(){document.getElementById("instructions").setAttribute("style","display:none")};document.getElementById("satellite_button").onclick=function(){if(document.getElementById("satellite_form").style.display==="none"||!document.getElementById("satellite_form").style.display){document.getElementById("satellite_form").setAttribute("style","display:block");document.getElementById("map_display").setAttribute("style","display:none");document.getElementById("instructions").setAttribute("style","display:none")}else document.getElementById("satellite_form").setAttribute("style","display:none")};document.getElementById("satellite_form_close").onclick=function(){document.getElementById("satellite_form").setAttribute("style","display:none")};document.getElementById("display_button").onclick=function(){if(document.getElementById("map_display").style.display==="none"||!document.getElementById("map_display").style.display){document.getElementById("map_display").setAttribute("style","display:block");document.getElementById("satellite_form").setAttribute("style","display:none");document.getElementById("instructions").setAttribute("style","display:none")}else document.getElementById("map_display").setAttribute("style","display:none")};document.getElementById("map_display_close").onclick=function(){document.getElementById("map_display").setAttribute("style","display:none")};document.getElementById("satellite_display_close").onclick=function(){document.getElementById("satellite_display").setAttribute("style","display:none");f=null;g=!0};document.getElementById("fullscreen_button").onclick=function(){var e=document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement,t=document.exitFullscreen||document.mozCancelFullScreen||document.webkitExitFullscreen,n=document.getElementById("wrapper"),r=n.requestFullscreen||n.webkitRequestFullscreen||n.mozRequestFullScreen||n.msRequestFullScreen;if(e&&t!=="undefined"&&t){t.call(document);document.getElementById("wrapper").removeAttribute("style")}else if(typeof r!="undefined"&&r){r.call(n);document.getElementById("wrapper").setAttribute("style","width:100%");document.getElementById("wrapper").removeAttribute("background")}O()};document.getElementById("zoom_out").onclick=function(){var e=t.cartesianToCartographic(n.getCamera().position).height,r=e/10;n.mode===Cesium.SceneMode.SCENE3D&&n.getCamera().controller.moveBackward(r)};document.getElementById("zoom_in").onclick=function(){var e=t.cartesianToCartographic(n.getCamera().position).height,r=e/10;n.mode===Cesium.SceneMode.SCENE3D&&n.getCamera().controller.moveForward(r)};document.getElementById("play_button").onclick=function(){g=!0};document.getElementById("pause_button").onclick=function(){g=!1};setInterval(function(){var e=new Cesium.JulianDate;if(o.length>0&&g){var t=T(o,e);o=t.satrecs;N(t.positions)}if(f!==null&&g){F();P()}},p);(function z(){n.initializeFrame();n.render();Cesium.requestAnimationFrame(z)})()})();