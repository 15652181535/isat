/*global document, window, console, setInterval, Cesium, Image, navigator, twoline2rv, sgp4, tle, gstime*/(function(){"use strict";function d(e){var t=tle.parseFile(e),n,u,c,h,p,d,v;r=[];s=[];i=[];o=[];for(n=0,u=t.length;n<u;n+=1){s[n]=t[n][0].trim();i[n]=t[n][1].slice(9,17);o[n]=t[n][2].split(" ")[1];c=twoline2rv(a,t[n][1],t[n][2],f,l);h=c.shift();p=c.shift();d=c.shift();v=c.shift();r.push(h)}}function v(e,t){var n=[],r=[],i=[],s,o,a,f,l,c,h,p;for(s=0,o=e.length;s<o;s+=1){a=new Cesium.JulianDate.fromTotalDays(e[s].jdsatepoch);f=a.getMinutesDifference(t);l=sgp4(e[s],f);c=l.shift();h=l.shift();p=l.shift();n.push(c);r.push(h);i.push(p)}u=r;return{satrecs:n,positions:r,velocities:r}}function m(e,t,n){var r=0,i=0,s=0,o=0,u=.00335281066474748,a=6.283185307179586,f=1.5707963267948966,l=3.141592653589793,c=6378.137,h=57.295;n.theta=Math.atan(t[1]/t[0]);n.lonInRads=n.theta-gstime(e);r=Math.sqrt(t[0]*t[0]+t[1]*t[1]);i=u*(2-u);n.latInRads=Math.atan(t[2]/r);do{s=n.latInRads;o=1/Math.sqrt(1-i*Math.sin(s)*Math.sin(s));n.latInRads=Math.atan((t[2]+c*o*i*Math.sin(s))/r)}while(Math.abs(n.latInRads-s)>=1e-10);n.alt=r/Math.cos(n.latInRads)-c*o;n.latInRads>f&&(n.latInRads-=a);n.latInDegrees=n.latInRads*h;n.lonInDegrees=n.lonInRads*h}function g(t,n){var i=document.getElementById("positions"),u=i.getElementsByTagName("tbody")[0],a,f,l,c,p,d,v,g,y;typeof u!="undefined"&&u!==null&&i.removeChild(u);u=document.createElement("tbody");i.appendChild(u);for(a=0,f=r.length;a<f&&a<h;a+=1){l=n.positions[a];c=n.velocities[a];y=m(t,l,r[a]);p=new Cesium.Cartesian3(c[0],c[1],c[2]);d=new Cesium.Cartesian3(l[0],l[1],l[2]);v=e.cartesianToCartographic(d);g=u.insertRow(-1);g.insertCell(-1).appendChild(document.createTextNode(s[a]));g.insertCell(-1).appendChild(document.createTextNode(o[a]));g.insertCell(-1).appendChild(document.createTextNode(p.magnitude().toFixed(0)));g.insertCell(-1).appendChild(document.createTextNode(r[a].latInDegrees.toFixed(3)));g.insertCell(-1).appendChild(document.createTextNode(r[a].lonInDegrees.toFixed(3)));var b=r[a].alt,w=b*.621371;g.insertCell(-1).appendChild(document.createTextNode(b.toFixed(3)));g.insertCell(-1).appendChild(document.createTextNode(w.toFixed(3)))}}function y(){var e=t.tick(),n=new Cesium.JulianDate,i=n.getJulianDayNumber()+n.getJulianTimeFraction();c&&(document.getElementById("date").textContent=e.toDate());if(r.length>0&&c){var s=v(r,n);r=s.satrecs;g(i,s)}}var e=Cesium.Ellipsoid.WGS84,t=new Cesium.Clock,n=new Cesium.PolylineCollection,r=[],i=[],s=[],o=[],u=[],a=84,f="m",l="n",c=!0,h=25,p=1e3;document.getElementById("play_button").onclick=function(){c=!0};document.getElementById("pause_button").onclick=function(){c=!1};d("/media/sot/tle/SMD.txt");document.getElementById("select_satellite_group").onchange=function(){n.removeAll();d("/media/sot/tle/"+this.value+".txt")};setInterval(y,p)})();