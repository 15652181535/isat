/*global document, window, console, setInterval, Cesium, Image, navigator, twoline2rv, sgp4, tle, gstime*/(function(){"use strict";function d(e){var t=tle.parseFile(e),n,u,c,h,p,d,v;r=[];s=[];i=[];o=[];for(n=0,u=t.length;n<u;n+=1){s[n]=t[n][0].trim();i[n]=t[n][1].slice(9,17);o[n]=t[n][2].split(" ")[1];c=twoline2rv(a,t[n][1],t[n][2],f,l);h=c.shift();p=c.shift();d=c.shift();v=c.shift();r.push(h)}}function v(e,t){var n=[],r=[],i=[],s,o,a,f,l,c,h,p;for(s=0,o=e.length;s<o;s+=1){a=new Cesium.JulianDate.fromTotalDays(e[s].jdsatepoch);f=a.getMinutesDifference(t);l=sgp4(e[s],f);c=l.shift();h=l.shift();p=l.shift();n.push(c);r.push(h);i.push(p)}u=r;return{satrecs:n,positions:r,velocities:r}}function m(e){var t=0,n=0,r=2*Math.PI;n=e;t=parseInt(n/r);n-=t*r;n<0&&(n+=r);return n}function g(e,t,n){var r=0,i=0,s=0,o=0,u=.00335281066474748,a=6.283185307179586,f=1.5707963267948966,l=3.141592653589793,c=6378.137,h=57.295;n.theta=Math.atan2(t[1],t[0]);n.lonInRads=m(n.theta-gstime(e));r=Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2));i=u*(2-u);n.latInRads=Math.atan2(t[2],r);do{s=n.latInRads;o=1/Math.sqrt(1-i*Math.pow(Math.sin(s),2));n.latInRads=Math.atan2(t[2]+c*o*i*Math.sin(s),r)}while(Math.abs(n.latInRads-s)>=1e-10);n.alt=r/Math.cos(n.latInRads)-c*o;n.latInRads>f&&(n.latInRads-=a);n.lonInRads>f&&(n.lonInRads=-a+n.lonInRads);n.latInDegrees=n.latInRads*h;n.lonInDegrees=n.lonInRads*h}function y(t,n){var i=document.getElementById("positions"),a=i.getElementsByTagName("tbody")[0],f,l,c,p,d,v,m,g,y;typeof a!="undefined"&&a!==null&&i.removeChild(a);a=document.createElement("tbody");i.appendChild(a);for(f=0,l=r.length;f<l&&f<h;f+=1){c=n.positions[f];p=n.velocities[f];y=calculateLatLonAlt(t,u[f],r[f]);d=new Cesium.Cartesian3(p[0],p[1],p[2]);v=new Cesium.Cartesian3(c[0],c[1],c[2]);m=e.cartesianToCartographic(v);g=a.insertRow(-1);g.insertCell(-1).appendChild(document.createTextNode(s[f]));g.insertCell(-1).appendChild(document.createTextNode(o[f]));g.insertCell(-1).appendChild(document.createTextNode(d.magnitude().toFixed(0)));g.insertCell(-1).appendChild(document.createTextNode(r[f].latInDegrees.toFixed(3)));g.insertCell(-1).appendChild(document.createTextNode(r[f].lonInDegrees.toFixed(3)));var b=r[f].alt,w=b*.621371;g.insertCell(-1).appendChild(document.createTextNode(b.toFixed(3)));g.insertCell(-1).appendChild(document.createTextNode(w.toFixed(3)))}}function b(){var e=t.tick(),n=new Cesium.JulianDate,i=n.getJulianDayNumber()+n.getJulianTimeFraction();c&&(document.getElementById("date").textContent=e.toDate());if(r.length>0&&c){var s=v(r,n);r=s.satrecs;y(i,s)}}var e=Cesium.Ellipsoid.WGS84,t=new Cesium.Clock,n=new Cesium.PolylineCollection,r=[],i=[],s=[],o=[],u=[],a=84,f="m",l="n",c=!0,h=25,p=1e3;document.getElementById("play_button").onclick=function(){c=!0};document.getElementById("pause_button").onclick=function(){c=!1};d("/media/sot/tle/SMD.txt");document.getElementById("select_satellite_group").onchange=function(){n.removeAll();d("/media/sot/tle/"+this.value+".txt")};setInterval(b,p)})();